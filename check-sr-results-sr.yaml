###############################################################################
#                   check-sr-results.py configuration file                    #
###############################################################################

# Note: this checks for SystemReady SR v2.5 results
# System Requirements Specification v2.2
# ACS SR pre-built image v23.09_2.0.0
---

check-sr-results-configuration:

# The following tree applies to all ACS-SR 2.0.0 versions.
tree:
  - dir: acs-auto-results
    min-entries: 9
    max-entries: 9
    tree:
      - dir: edk2-test-parser
        min-entries: 1
        max-entries: 1
        tree:
          - file: edk2-test-parser.log
            must-contain:
              - SCT Summary
              - Failure:|0|
              - Dropped by group
              - Failure by group
              - Ignored by group
              - Warning by group
      - dir: app_output
        min-entries: 2
        max-entries: 2
        tree:
          - file: CapsuleApp_ESRT_table_info.log
            capsuleapp-esrt:
            must-contain:
              - ESRT TABLE
              - 'EFI_SYSTEM_RESOURCE_TABLE:'
              - EFI_SYSTEM_RESOURCE_ENTRY
              - FwClass
            error-if-contains:
              - FwResourceCount    - 0x0
              - FwResourceCountMax - 0x0
              - ESRT - Not Found
          - file: CapsuleApp_FMP_protocol_info.log
            must-contain:
              - FMP DATA
      - dir: fwts
        min-entries: 1
        max-entries: 1
        tree:
          - file: FWTSResults.log
            must-contain:
              - 'Results generated by fwts: Version V23.07.00'
              - 'Running tests: esrt uefibootpath esrt uefibootpath
	         uefirtmisc uefirtvariable'
              - 'uefirttime dmicheck xsdt spcr rsdp_sbbr pptt method
                 mcfg madt gtdt fadt_sbbr'
              - 'dbg2 acpi_sbbr acpitables.'
              - 'esrt: Sanity check UEFI ESRT Table.'
              - 'Test Failure Summary'
              - 'Total:'
            warn-if-contains:
              - 'WARNING:'
              - Aborted test
            error-if-contains:
              - FAILED
              - This is an invalid entry.
              - 'esrt: Cannot find any entries on directory
                /sys/firmware/efi/esrt/entries'
              - 'esrt: The FwResourceCount value should not be 0.'
              - 'esrt: The FwResourceCountMax value should not be 0.'
              - 'uefirtmisc: Failed to get high monotonic count with UEFI
                runtime service.'
              - 'uefirttime: Failed to set time with UEFI runtime service.'
      - dir: linux
        min-entries: 4
        max-entries: 4
        tree:
          - file: BsaResultsApp.log
            must-contain:
              - SystemReady SR ACS v2.0.0
              - BSA Architecture Compliance Suite
              - Version 1.0.6
              - Starting tests
              - BSA tests complete
          - file: BsaResultsKernel.log
            must-contain:
              - Number of PE detected
              - Tests Failed =  0
          - file: SbsaResultsApp.log
            must-contain:
              - SystemReady SR ACS v2.0.0
              - SBSA Architecture Compliance Suite
              - Version 7.1.3
              - Starting tests
              - SBSA tests complete
          - file: SbsaResultsKernel.log
            must-contain:
              - Number of PE detected
              - Tests Failed =  0
      - dir: linux_dump  # Needs update to match SR ACS output
        min-entries: 11
        max-entries: 11
        tree:
          - file: lspci.log
      - dir: sct_results
        min-entries: 4
        max-entries: 4
        tree:
          - dir: EfiCompliantBBTest
            min-entries: 1
            max-entries: 1
            tree:
              - file: EfiCompliant.ini
                must-contain:
                  - Test Configuration Specific
                  - Platform Specific
          - dir: Overall
            min-entries: 2
            max-entries: 2
            tree:
              - file: Summary.ekl
                must-contain:
                  - '|HEAD|'
                  - '|TERM|'
              - file: Summary.log
                must-contain:
                  - 'Arm ACS Version: v2.0.0-BETA-0'
                  - 'Test Finished:'
          - dir: SCRT
            min-entries: 2
            max-entries: 2
            tree:
              - file: SCRT.conf
              - file: SCRT.log
                must-contain:
                  - 'SetVariable Pass'
                  - 'GetVariable Pass'
                  - 'GetNextVariableName Pass'
                  - 'QueryVariable Pass'
                  - 'GetTime Pass'
                  - 'SetTime Pass'
                  - 'SetWakeupTime Pass'
                  - 'GetWakeupTime Pass'
                  - 'QueryCapsule Pass'
                  - 'UpdateCapsule Pass'
                  - 'GetNextCount Pass'
                  - 'WarmReset Pass'
          - dir: Sequence
            min-entries: 4
            max-entries: 4
            tree:
              - file: SBBR_manual.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
              - file: SBBR_extd_run.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
              - file: SBBR.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
              - file: BBSR.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
      - dir: uefi
        min-entries: 2
        max-entries: 7  # Ignore temp/ leftover by ACS script
        tree:
          - file: SbsaResults.log
            must-contain:
              - SBSA Architecture Compliance Suite
              - Version 7.1.3
              - Starting tests
              - 'PE_INFO: Number of PE detected'
              - Total Tests run
              - SBSA tests complete. Reset the system.
              - Tests Failed =    0
          - file: BsaResults.log
            must-contain:
              - BSA Architecture Compliance Suite
              - Version 1.0.6
              - Starting tests
              - 'PE_INFO: Number of PE detected'
              - Operating System
              - Total Tests run
              - BSA tests complete. Reset the system.
              - Tests Failed =    0
            error-if-contains:
              - FAIL
              - failure
              - Incorrect
      - dir: uefi_dump  # Update for SR ACS efi_dump script
        min-entries: 16
        max-entries: 17  # Allow for acpidump file
        tree:
          - file: acpiview_l.log  # TODO add must-contains
          - file: devtree.log
          - file: dmem.log
          - file: map.log
          - file: uefi_version.log
          - file: bcfg.log
          - file: devices.log
            must-contain:
              - Device Name
          - file: dh.log
            must-contain:
              - Handle dump
              - DevicePath
              - FirmwareManagement
              - SimpleTextOut
          - file: dmpstore.log
            must-contain:
              - Variable
              - SecureBoot
          - file: drivers.log
            must-contain:
              - DRIVER NAME
          - file: memmap.log
            must-contain:
              - '# Pages'
              - Available
              - 'Total Memory:'
          - file: pci.log
          - file: smbiosview.log
            must-contain:
              - 'SMBIOS 3.0 (64-bit) Entry Point Structure:'
  - dir: docs
    optional:
  - dir: fw
    min-entries: 3
    tree:
      - dir: fw-image-files
        min-entries: 0
      - dir: screenshots
        min-entries: 0
      - dir: uefi-shell-cmds-logs
        min-entries: 3
        tree:
          - file: 'dh_d_v.log'
          - file: 'bcfg_boot_dump_v.log'
          - file: '*console.log'
            must-contain:
              - 'connect -r'
              - 'acpiview -s DSDT -d'
              - 'acpiview -s SSDT -d'
              - 'ifconfig -l'
              - '0% packet loss'
  - dir: manual-results
    optional:
  - dir: os-logs
    min-entries: 2
    tree:
      - file: 'OS-image-download-links.txt'
        optional:
        must-contain:
          - For SystemReady SR
      - dir: 'linux-*'
        tree:
          - dir: "systemready-cert-logs"
            tree:
              - file: lspci.txt
              - file: lspci-vvv.txt
              - file: dmesg.txt
              - file: cat-proc-interrupts.txt
              - file: cat-proc-cpuinfo.txt
              - file: cat-proc-meminfo.txt
              - file: lscpu.txt
              - file: lsblk.txt
              - file: lsusb.txt
              - file: dmidecode.txt
              - file: dmidecode.bin
              - file: uname-a.txt
              - file: cat-etc-os-release.txt
              - file: date.txt
              - file: timedatectl.txt
              - file: hwclock.txt
              - file: efibootmgr.txt
              - file: efibootmgr-t-20.txt
              - file: efibootmgr-t-5.txt
              - file: efibootmgr-c.txt
              - file: ifconfig.txt
              - file: ip-addr-show.txt
              - file: ping-c-5-www-arm-com.txt
                must-contain:
                  - '5 packets transmitted, 5 received, 0% packet loss'
              - file: acpi.log
              - file: "*.dat"
              - file: "*.dsl"
              - file: date-set-202212150530.txt
              - file: date-after-set.txt
                must-contain:
                  - 'Thu Dec 15 05:30'
              - file: hwclock-after-set.txt
                must-contain:
                  - 2023-01-01 09:10
              - dir: firmware
          - file: '*console.log'
            warn-if-contains:
              - -dirty
              - 'EFI stub: ERROR:'
              - 'FIRMWARE BUG:'
              - No EFI system partition
      - dir: 'winpe-*'
        tree:
          - file: '*console.log'
            must-contain:
              - "Product: Windows Preinstallation Environment"
              - "KRNL: Load succeeded."
              - "SAC is retrieving IP Addresses"
              - "Time (GMT):"
              - "The Command Prompt session was successfully launched."
              - "Microsoft Windows [Version 10.0.25398.1]"
              - "pnputil/enum-devices"
              - "Microsoft PnP Utility"
              - "Microsoft DiskPart"
              - "Disk ###  Status         Size     Free     Dyn  Gpt"
              - "Volume ###  Ltr  Label        Fs     Type        Size"
              - ">dir"
              - "Windows IP Configuration"
              - "The current date is"
              - "The current time is:"
              - "The SAC will become unavailable soon.  The
                computer is shutting down."
            warn-if-contains:
              - "There are no IP Addresses available."
      - dir: 'vmware-*'
        optional:
        tree:
          - file: '*console.log'
            must-contain:
              - dmesg
              - lspci
              - irqinfo
              - 'localcli storage core adapter list'
              - 'localcli hardware pci list'
              - 'esxcli hardware cpu list'
              - 'esxcli hardware usb passthrough device list'
              - 'esxcli storage filesystem list'
              - 'Mount Point'
              - '/vmfs/volumes/'
              - 'esxcli storage core device list'
              - 'Display Name: '
              - 'cd /dev/disks'
              - '/dev/disks] ls'
              - 'vim-cmd hostsvc/hosthardware'
              - 'vendor ='
              - 'vmware -v'
              - 'VMware ESXi'
              - 'reboot -f'
  - file: report.txt
    must-contain:
      - General information
      - Test Logs collected

overlays:
  - when-any: [SystemReady SR v2.5 with ACS v24.03_2.1.0]
    tree:
      - dir: acs-auto-results
        min-entries: 9
        max-entries: 9
        tree:
          - dir: fwts
            min-entries: 1
            max-entries: 1
            tree:
              - file: FWTSResults.log
                must-contain:
                  - 'Results generated by fwts: Version V24.01.00'
                  - 'Running tests: esrt uefibootpath aest cedt
                    slit srat hmat pcct pdtt bgrt bert'
                  - 'einj erst hest sdei nfit iort mpam ibft ras2
                    esrt uefibootpath uefirtmisc'
                  - 'uefirtvariable uefirttime dmicheck xsdt spcr
                    rsdp_sbbr pptt method mcfg madt'
                  - 'gtdt fadt_sbbr dbg2 acpi_sbbr acpitables.'
          - dir: linux
            min-entries: 4
            max-entries: 4
            tree:
              - file: BsaResultsApp.log
                must-contain:
                  - Version 1.0.8
              - file: SbsaResultsApp.log
                must-contain:
                  - Version 7.1.5
          - dir: uefi
            min-entries: 2
            max-entries: 6
            tree:
              - file: SbsaResults.log
                must-contain:
                  - Version 7.1.5
              - file: BsaResults.log
                must-contain:
                  - Version 1.0.8
