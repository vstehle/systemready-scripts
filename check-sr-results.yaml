###############################################################################
#                   check-sr-results.py configuration file                    #
###############################################################################

# Note: for the moment, this checks for SystemReady IR 2.0 results.
---

check-sr-results-configuration:

# The following tree applies to all ACS-IR 2.0 versions.
tree:
  - file: acs-console.log
    must-contain:
      - Booting `bbr/bsa'
      - Test preparing...
      - Done!
      - BSA Architecture Compliance Suite
      - Starting tests
      - Total Tests run
      - BSA tests complete. Reset the system.
      - 'EFI stub: Booting Linux Kernel...'
      - Linux version
      - 'Test: UEFI'
      - Loading BSA ACS Linux Driver
      - Executing BSA ACS Application
      - ACS run is completed
      - Please press <Enter> to continue ...
    warn-if-contains:
      - -dirty
      - 'EFI stub: ERROR: FIRMWARE BUG: kernel image not aligned on 64k
        boundary'
  - dir: acs_results
    min-entries: 7  # Allow missing result.md
    max-entries: 8
    tree:
      - file: result.md
        sct-parser-result-md:
          seq-file: sct_results/Sequence/EBBR.seq
        must-contain:
          - SCT Summary
          - Dropped:|0|
          - Failure:|0|
          - Warning:|0|
          - Dropped by group
          - Failure by group
          - Ignored by group
          - Warning by group
      - dir: app_output
        min-entries: 2
        max-entries: 2
        tree:
          - file: CapsuleApp_ESRT_table_info.log
            capsuleapp-esrt:
            must-contain:
              - ESRT TABLE
              - 'EFI_SYSTEM_RESOURCE_TABLE:'
              - EFI_SYSTEM_RESOURCE_ENTRY
              - FwClass
            error-if-contains:
              - FwResourceCount    - 0x0
              - FwResourceCountMax - 0x0
              - ESRT - Not Found
          - file: CapsuleApp_FMP_protocol_info.log
            must-contain:
              - FMP DATA
      - dir: fwts
        min-entries: 1
        max-entries: 1
        tree:
          - file: FWTSResults.log
            must-contain:
              - SystemReady IR ACS v2.0.0 Beta 0
              - FWTS v22.05.00
              - 'Results generated by fwts: Version V22.05.00'
              - 'esrt: Sanity check UEFI ESRT Table.'
              - Test Failure Summary
              - 'Critical failures: NONE'
              - 'High failures: NONE'
              - 'Medium failures: NONE'
              - 'Low failures: NONE'
              - 'Other failures: NONE'
              - 'Total:'
      - dir: linux_acs
        min-entries: 1
        max-entries: 1
        tree:
          - dir: bsa_acs_app
            min-entries: 1
            max-entries: 1
            tree:
              - file: BSALinuxResults.log
                must-contain:
                  - SystemReady IR ACS v2.0.0 Beta 0
                  - BSA v1.0.1
                  - BSA Architecture Compliance Suite
                  - Version 1.0.1
                  - Starting tests
                  - BSA tests complete
      - dir: linux_dump
        min-entries: 1
        max-entries: 1
        tree:
          - file: lspci.log
            can-be-empty:
      - dir: sct_results
        min-entries: 3
        max-entries: 3
        tree:
          - dir: EfiCompliantBBTest
            min-entries: 1
            max-entries: 1
            tree:
              - file: EfiCompliant.ini
                must-contain:
                  - Test Configuration Specific
                  - Platform Specific
          - dir: Overall
            min-entries: 2
            max-entries: 2
            tree:
              - file: Summary.ekl
                must-contain:
                  - '|HEAD|'
                  - '|TERM|'
              - file: Summary.log
                must-contain:
                  - 'Arm ACS Version: SystemReady IR ACS v2.0.0 Beta-0'
                  - BBR ACS 1.0.1 (EBBR)
                  - 'Test Finished:'
          - dir: Sequence
            min-entries: 2
            max-entries: 2
            tree:
              - file: EBBR_manual.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
              - file: EBBR.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
      - dir: uefi
        min-entries: 2
        max-entries: 2
        tree:
          - file: BsaDevTree.dtb
            devicetree:
          - file: BsaResults.log
            must-contain:
              - BSA Architecture Compliance Suite
              - Version 1.0.1
              - Starting tests
              - 'PE_INFO: Number of PE detected'
              - Operating System
              - Total Tests run
              - BSA tests complete. Reset the system.
      - dir: uefi_dump
        min-entries: 7
        max-entries: 8
        tree:
          - file: bcfg.log
          - file: devices.log
            must-contain:
              - Device Name
          - file: dh.log
            must-contain:
              - Handle dump
              - DevicePath
              - FirmwareManagement
              - SimpleTextOut
          - file: dmpstore.log
            must-contain:
              - Variable
              - SecureBoot
          - file: drivers.log
            must-contain:
              - DRIVER NAME
          - file: memmap.log
            must-contain:
              - '# Pages'
              - Available
              - 'Total Memory:'
          - file: pci.log
          - file: smbiosview.log
            optional:
            must-contain:
              - 'SMBIOS Entry Point Structure:'
  - dir: docs
    optional:
  - dir: fw
    min-entries: 2
    tree:
      - file: u-boot-sniff.log
        must-contain:
          # We check only that all non-hw-related commands are there for now.
          # RTC is a special case as we have an emulation in U-Boot.
          # We omit the bootefi hello and selftest as not everybody keeps them
          # in production.
          - help
          - version
          - printenv
          - printenv -e
          - bdinfo
          - rtc list
          - efidebug devices
          - efidebug drivers
          - efidebug dh
          - efidebug memmap
          - efidebug tables
          - efidebug boot dump
        warn-if-contains:
          - -dirty
      - file: uefi-sniff.log
        optional:
        must-contain:
          - pci
          - drivers
          - devices
          - devtree
          - dmpstore
          - dh -d -v
          - memmap
          - smbiosview
          - CapsuleApp.efi -P
          - CapsuleApp.efi -E
      - file: capsule-update.log
        must-contain:
          - CapsuleApp.efi
      - file: 'capsule*.bin'
        uefi-capsule:
  - dir: manual-results
    optional:
  - dir: os-logs
    min-entries: 2
    tree:
      - dir: 'linux-*'
        tree:
          - file: 'console.log'
            must-contain:
              - dmesg
              - Linux version
              - lspci -vvv
              - lscpu
              - lsblk
              - dmidecode
              - uname -a
              - efibootmgr
              - tar
            warn-if-contains:
              - 'EFI stub: ERROR: FIRMWARE BUG: kernel image not aligned on 64k
                boundary'
          - file: 'sys-firmware.tar.gz'
  - file: report.txt
    must-contain:
      - General information
      - Test Logs collected

overlays:

  # (Ab)use the overlay mechanism to emit an error with IR v1.x.
  - when-any: [IR v1.]
    tree:
      - file: '!!! This is not the right configuration to use for checking IR
        v1.x results; use check-sr-results-ir1.yaml instead !!!'

  # (Ab)use the overlay mechanism to emit an error with SIE.
  - when-any: [SIE v1]
    tree:
      - file: '!!! This is not the right configuration to use for checking SIE
        results !!!'
