###############################################################################
#                   check-sr-results.py configuration file                    #
###############################################################################

# Note: for the moment, this checks for SystemReady IR results.
---

check-sr-results-configuration:

# The following tree applies to all ACS-IR versions.
tree:
  - file: acs-console.log
    must-contain:
      - Booting `bbr/bsa'
      - Test preparing...
      - Done!
      - BSA Architecture Compliance Suite
      # We explicitly allow the Bsa.efi NOT to complete by NOT looking for the
      # end message. It is only informative and it hits crashes on some
      # platforms.
      - 'EFI stub: Booting Linux Kernel...'
      - Linux version
      - 'Test: UEFI'
      - '/ #'
    warn-if-contains:
      - -dirty
      - 'EFI stub: ERROR: FIRMWARE BUG: kernel image not aligned on 64k
        boundary'
  - dir: acs_results
    tree:
      - file: result.md
        must-contain:
          - SCT Summary
          - Dropped:|0|
          - Failure:|0|
          - Warning:|0|
          - Dropped by group
          - Failure by group
          - Ignored by group
          - Warning by group
      - dir: app_output
        tree:
          - file: CapsuleApp_ESRT_table_info.log
            must-contain:
              - ESRT TABLE
          - file: CapsuleApp_FMP_protocol_info.log
            must-contain:
              - FMP DATA
      - dir: fwts
        tree:
          - file: FWTSResults.log
            must-contain:
              - 'Results generated by fwts: Version'
              - Test Failure Summary
              - 'Critical failures: NONE'
              - 'High failures: NONE'
              - 'Medium failures: NONE'
              - 'Low failures: NONE'
              - 'Other failures: NONE'
              - 'Total:'
      - dir: linux_dump
        tree:
          - file: lspci.log
            can-be-empty:
      - dir: sct_results
        tree:
          - dir: EfiCompliantBBTest
            tree:
              - file: EfiCompliant.ini
          - dir: Overall
            tree:
              - file: Summary.ekl
                must-contain:
                  - '|HEAD|'
                  - '|TERM|'
              - file: Summary.log
                must-contain:
                  - 'Arm ACS Version:'
                  - 'Test Finished:'
          - dir: Sequence
            tree:
              - file: EBBR_manual.seq
              - file: EBBR.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
      - dir: uefi
        tree:
          - file: BsaResults.log
            must-contain:
              - 'PE_INFO: Number of PE detected'
              - 'Operating System'
              # We explicitly allow the Bsa.efi NOT to complete by NOT looking
              # for the end message. It is only informative and it hits crashes
              # on some platforms.
      - dir: uefi_dump
        tree:
          - file: acpiview_l.log
          - file: acpiview.log
          - file: acpiview_r.log
          - file: bcfg.log
          - file: devices.log
            must-contain:
              - Device Name
          - file: dh.log
            must-contain:
              - Handle dump
              - DevicePath
              - SimpleTextOut
              - Shell
          - file: dmpstore.log
            must-contain:
              - Variable
          - file: drivers.log
            must-contain:
              - DRIVER NAME
          - file: memmap.log
            must-contain:
              - '# Pages'
              - Available
              - 'Total Memory:'
          - file: pci.log
          - file: smbiosview.log
            must-contain:
              - 'SMBIOS Entry Point Structure:'
  - dir: docs
    optional:
  - dir: fw
    tree:
      - file: u-boot-sniff.log
        must-contain:
          # We check only that all non-hw-related commands are there for now.
          # RTC is a special case as we have an emulation in U-Boot.
          # We omit the bootefi hello and selftest as not everybody keeps them
          # in production.
          - help
          - version
          - printenv
          - printenv -e
          - bdinfo
          - rtc list
          - efidebug devices
          - efidebug drivers
          - efidebug dh
          - efidebug memmap
          - efidebug tables
          - efidebug boot dump
        warn-if-contains:
          - -dirty
      - file: uefi-sniff.log
        optional:
        must-contain:
          - pci
          - drivers
          - devices
          - devtree
          - dmpstore
          - dh -d -v
          - memmap
          - smbiosview
          - CapsuleApp.efi -P
          - CapsuleApp.efi -E
      - file: capsule-update.log
        must-contain:
          - CapsuleApp.efi
  - dir: manual-results
    tree:
      - dir: bsa-linux
        tree:
          - file: console.log
            must-contain:
              - insmod /lib/modules/bsa_acs.ko
              - /bin/bsa
              # The 'init BSA Driver' does not show up with ACS-IR < v1.0: do
              # not check it for now.
              # The 'BSA Architecture Compliance Suite' headline is sometimes
              # garbled in the UART log due to kernel messages. We therefore
              # explicitely do not check it.
              - BSA tests complete
  - dir: os-logs
    tree:
      - dir: '*-*'
        tree:
          - file: '*console.log'
            must-contain:
              - dmesg
              - Linux version
              - lspci -vvv
              - lscpu
              - lsblk
              - dmidecode
              - uname -a
              - efibootmgr
              - tar
            warn-if-contains:
              - 'EFI stub: ERROR: FIRMWARE BUG: kernel image not aligned on 64k
                boundary'
          - file: '*sys-firmware.tar.gz'
  - file: report.txt
    must-contain:
      - General information
      - Test Logs collected

overlays:
  # A few files were not present in ACS-IR v21.05_0.8_BETA-0; make them
  # optional.
  - when-all: [ACS-IR v21.05_0.8_BETA-0]
    tree:
      - dir: acs_results
        tree:
          - dir: uefi_dump
            tree:
              - file: bcfg.log
                optional:
          - dir: sct_results
            tree:
              - dir: Sequence
                tree:
                  - file: EBBR_manual.seq
                    optional:

  # A few files were only present in ACS-IR v21.05_0.8_BETA-0; make them
  # optional for the subsequent ACS-IR versions.
  - when-any: [ACS-IR v21.07_0.9_BETA, ACS-IR v21.09_1.0]
    tree:
      - dir: acs_results
        tree:
          - dir: uefi_dump
            tree:
              - file: acpiview_l.log
                optional:
              - file: acpiview.log
                optional:
              - file: acpiview_r.log
                optional:
              - file: smbiosview.log
                optional:
