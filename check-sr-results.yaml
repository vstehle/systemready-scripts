###############################################################################
#                   check-sr-results.py configuration file                    #
###############################################################################

# Note: for the moment, this checks for SystemReady IR 2.0 results.
---

check-sr-results-configuration:

# The following tree applies to all ACS-IR 2.0 versions.
tree:
  - file: acs-console.log
    must-contain:
      - Booting `bbr/bsa'
      - Test preparing...
      - Done!
      - BSA Architecture Compliance Suite
      - Starting tests
      - Total Tests run
      - BSA tests complete. Reset the system.
      - 'EFI stub: Booting Linux Kernel...'
      - Linux version
      - 'Test: UEFI'
      - Loading BSA ACS Linux Driver
      - Executing BSA ACS Application
      - ACS run is completed
      - Please press <Enter> to continue ...
    warn-if-contains:
      - -dirty
      - 'EFI stub: ERROR:'
      - 'FIRMWARE BUG:'
      - No EFI system partition
  - dir: acs_results
    min-entries: 8  # Allow missing result.md
    max-entries: 9
    tree:
      - file: result.md
        sct-parser-result-md:
          seq-file: sct_results/Sequence/EBBR.seq
        must-contain:
          - SCT Summary
          - Dropped:|0|
          - Failure:|0|
          - Warning:|0|
          - Dropped by group
          - Failure by group
          - Ignored by group
          - Warning by group
      - dir: app_output
        min-entries: 2
        max-entries: 2
        tree:
          - file: CapsuleApp_ESRT_table_info.log
            capsuleapp-esrt:
            must-contain:
              - ESRT TABLE
              - 'EFI_SYSTEM_RESOURCE_TABLE:'
              - EFI_SYSTEM_RESOURCE_ENTRY
              - FwClass
            error-if-contains:
              - FwResourceCount    - 0x0
              - FwResourceCountMax - 0x0
              - ESRT - Not Found
          - file: CapsuleApp_FMP_protocol_info.log
            must-contain:
              - FMP DATA
      - dir: fwts
        min-entries: 1
        max-entries: 1
        tree:
          - file: FWTSResults.log
            must-contain:
              - SystemReady IR ACS v2.0.0 Beta-1
              - FWTS v22.07.00
              - 'Results generated by fwts: Version V22.07.00'
              - 'Running tests: uefivarinfo esrt uefibootpath dt_base uefirtmisc
                uefirtvariable'
              - 'esrt: Sanity check UEFI ESRT Table.'
              - Test Failure Summary
              - 'Critical failures: NONE'
              - 'High failures: NONE'
              - 'Medium failures: NONE'
              - 'Low failures: NONE'
              - 'Other failures: NONE'
              - 'Total:'
            warn-if-contains:
              - 'WARNING:'
              - Aborted test
            error-if-contains:
              - FAILED
              - This is an invalid entry.
              - 'esrt: Cannot find any entries on directory
                /sys/firmware/efi/esrt/entries'
              - 'esrt: The FwResourceCount value should not be 0.'
              - 'esrt: The FwResourceCountMax value should not be 0.'
              - 'uefirtmisc: Failed to get high monotonic count with UEFI
                runtime service.'
              - 'uefirttime: Failed to set time with UEFI runtime service.'
      - dir: linux_acs
        min-entries: 1
        max-entries: 1
        tree:
          - dir: bsa_acs_app
            min-entries: 2
            max-entries: 2
            tree:
              - file: BSALinuxResults.log
                must-contain:
                  - SystemReady IR ACS v2.0.0 Beta-1
                  - BSA v1.0.2
                  - BSA Architecture Compliance Suite
                  - Version 1.0.1
                  - Starting tests
                  - BSA tests complete
              - file: BsaResultsKernel.log
                must-contain:
                  - Number of PE detected
                  - Tests Failed =  0
      - dir: linux_dump
        min-entries: 1
        max-entries: 1
        tree:
          - file: lspci.log
            can-be-empty:
      - dir: linux_tools
        min-entries: 1
        max-entries: 2  # Allow dt-validate.log.old
        tree:
          - file: dt-validate.log*
            must-contain:
              - 'DeviceTree bindings of Linux kernel version: 5.19.10'
              - 'dtschema version: 2022.9'
              - The FDT is compliant according to schema
      - dir: sct_results
        min-entries: 3
        max-entries: 3
        tree:
          - dir: EfiCompliantBBTest
            min-entries: 1
            max-entries: 1
            tree:
              - file: EfiCompliant.ini
                must-contain:
                  - Test Configuration Specific
                  - Platform Specific
          - dir: Overall
            min-entries: 2
            max-entries: 2
            tree:
              - file: Summary.ekl
                must-contain:
                  - '|HEAD|'
                  - '|TERM|'
              - file: Summary.log
                must-contain:
                  - 'Arm ACS Version: SystemReady IR ACS v2.0.0 Beta-1'
                  - BBR ACS 1.0.2 (EBBR)
                  - 'Test Finished:'
          - dir: Sequence
            min-entries: 3
            max-entries: 3
            tree:
              - file: EBBR_manual.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
              - file: EBBR.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
              - file: BBSR.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
      - dir: uefi
        min-entries: 2
        max-entries: 3  # Allow to generate BsaDevTree.dtb.log
        tree:
          - file: BsaDevTree.dtb
            devicetree:
          - file: BsaDevTree.dtb.log  # This will be generated
            must-contain:
              - + DTC
              - + DT-VALIDATE
              - + END
          - file: BsaResults.log
            must-contain:
              - BSA Architecture Compliance Suite
              - Version 1.0.1
              - Starting tests
              - 'PE_INFO: Number of PE detected'
              - Operating System
              - Total Tests run
              - BSA tests complete. Reset the system.
      - dir: uefi_dump
        min-entries: 7
        max-entries: 8
        tree:
          - file: bcfg.log
          - file: devices.log
            must-contain:
              - Device Name
          - file: dh.log
            must-contain:
              - Handle dump
              - DevicePath
              - FirmwareManagement
              - SimpleTextOut
          - file: dmpstore.log
            must-contain:
              - Variable
              - SecureBoot
          - file: drivers.log
            must-contain:
              - DRIVER NAME
          - file: memmap.log
            must-contain:
              - '# Pages'
              - Available
              - 'Total Memory:'
          - file: pci.log
          - file: smbiosview.log
            optional:
            must-contain:
              - 'SMBIOS Entry Point Structure:'
  - dir: docs
    optional:
  - dir: fw
    min-entries: 3
    tree:
      - file: u-boot-sniff.log
        must-contain:
          # We check only that all non-hw-related commands are there for now.
          # RTC is a special case as we have an emulation in U-Boot.
          - help
          - version
          - printenv
          - printenv -e
          - bdinfo
          - rtc list
          - efidebug devices
          - efidebug drivers
          - efidebug dh
          - efidebug memmap
          - efidebug tables
          - efidebug query
          - efidebug boot dump
          - efidebug capsule esrt
          # We omit the bootefi hello and selftest as not everybody keeps them
          # in production.
        warn-if-contains:
          - -dirty
          - 'EFI stub: ERROR:'
          - 'FIRMWARE BUG:'
          - No EFI system partition
      - file: uefi-sniff.log
        must-contain:
          - dmem
          - pci
          - drivers
          - devices
          - devtree
          - dmpstore
          - dh -d -v
          - memmap
          - smbiosview
        warn-if-contains:
          - -dirty
          - 'EFI stub: ERROR:'
          - 'FIRMWARE BUG:'
          - No EFI system partition
      - file: capsule-update.log
        must-contain:
          - CapsuleApp.efi -D
          - CapsuleApp.efi
        warn-if-contains:
          - -dirty
          - 'EFI stub: ERROR:'
          - 'FIRMWARE BUG:'
          - No EFI system partition
      - file: capsule-on-disk.log
        must-contain:
          - CapsuleApp.efi -D
          - -OD
        warn-if-contains:
          - -dirty
          - 'EFI stub: ERROR:'
          - 'FIRMWARE BUG:'
          - No EFI system partition
      - file: 'capsule*.bin'
        uefi-capsule:
  - dir: manual-results
    optional:
  - dir: os-logs
    min-entries: 2
    tree:
      - file: 'OS-image-download-links.txt'
        optional:
        must-contain:
          - For SystemReady IR
      - dir: 'linux-*'
        tree:
          - file: '*console.log'
            warn-if-not-named: console.log
            must-contain:
              - dmesg
              - Linux version
              - lspci -vvv
              - lscpu
              - lsblk
              - dmidecode
              - uname -a
              - efibootmgr
              - tar
            warn-if-contains:
              - -dirty
              - 'EFI stub: ERROR:'
              - 'FIRMWARE BUG:'
              - No EFI system partition
          - file: '*sys-firmware.tar.gz'
            warn-if-not-named: sys-firmware.tar.gz
  - file: report.txt
    must-contain:
      - General information
      - Test Logs collected

overlays:

  - when-any: [IR v2.0 with SIE]
    tree:
      - dir: acs_results
        min-entries: 9   # Allow missing result.md
        max-entries: 10  # Allow SIE folder
        tree:
          - dir: SIE
            min-entries: 3  # Allow missing result.md
            max-entries: 4
            tree:
              - file: result.md
                sct-parser-result-md:
                  seq-file: sct_results/Sequence/BBSR.seq
                must-contain:
                  - SCT Summary
                  - Dropped:|0|
                  - Failure:|0|
                  - Warning:|0|
                  - Dropped by group
                  - Failure by group
                  - Ignored by group
                  - Warning by group
              - dir: fwts
                min-entries: 1
                max-entries: 1
                tree:
                  - file: FWTSResults.log
                    must-contain:
                      - 'Results generated by fwts: Version V22.07.00'
                      - 'Running tests: uefirtauthvar tpm2.'
                      - Test Failure Summary
                      - 'Critical failures: NONE'
                      - 'High failures: NONE'
                      - 'Medium failures: NONE'
                      - 'Low failures: NONE'
                      - 'Other failures: NONE'
                      - 'Total:'
                    warn-if-contains:
                      - 'WARNING:'
                    error-if-contains:
                      - FAILED
                      - 'uefirtauthvar: Failed to create authenticated variable
                        with UEFI runtime service.'
                      - 'uefirtauthvar: Failed to set authenticated variable
                        with UEFI runtime service.'
                      - 'uefirtauthvar: Set authenticated variable expected
                        fail but success'
                      - 'uefirtauthvar: Set authenticated variable fail'
              - dir: sct_results
                min-entries: 3
                max-entries: 3
                tree:
                  - dir: EfiCompliantBBTest
                    min-entries: 1
                    max-entries: 1
                    tree:
                      - file: EfiCompliant.ini
                        must-contain:
                          - Test Configuration Specific
                          - Platform Specific
                  - dir: Overall
                    min-entries: 2
                    max-entries: 2
                    tree:
                      - file: Summary.ekl
                        must-contain:
                          - '|HEAD|'
                          - '|TERM|'
                      - file: Summary.log
                        must-contain:
                          - 'Arm ACS Version: SystemReady IR ACS v2.0.0 Beta-1'
                          - BBR ACS 1.0.2 (EBBR)
                          - 'Test Finished:'
                  - dir: Sequence
                    min-entries: 3
                    max-entries: 3
                    tree:
                      - file: BBSR.seq
                        must-contain:
                          - '[Test Case]'
                          - Revision=
                          - Guid=
                          - Name=
                          - Order=
                          - Iterations=
                      - file: EBBR_manual.seq
                        must-contain:
                          - '[Test Case]'
                          - Revision=
                          - Guid=
                          - Name=
                          - Order=
                          - Iterations=
                      - file: EBBR.seq
                        must-contain:
                          - '[Test Case]'
                          - Revision=
                          - Guid=
                          - Name=
                          - Order=
                          - Iterations=
              - dir: tpm2
                min-entries: 0

  # (Ab)use the overlay mechanism to emit an error with IR v1.x.
  - when-any: [IR v1.]
    tree:
      - file: '!!! This is not the right configuration to use for checking IR
        v1.x results; use check-sr-results-ir1.yaml instead !!!'

  # (Ab)use the overlay mechanism to emit an error with SIE.
  - when-any: [SIE v1]
    tree:
      - file: '!!! This is not the right configuration to use for checking SIE
        results !!!'
