###############################################################################
#                   check-sr-results.py configuration file                    #
###############################################################################

# Note: for the moment, this checks for SystemReady IR 2.0 results.
---

check-sr-results-configuration:

# The following tree applies to all ACS-IR 2.0 versions.
tree:
  - file: acs-console.log
    must-have-esp:
    must-contain:
      - Booting `bbr/bsa'
      - Press any key to stop the EFI SCT running
      - Test preparing...
      - Done!
      - Starting UEFI Debug dump
      - BSA Architecture Compliance Suite
      - Starting tests
      - Total Tests run
      - BSA tests complete. Reset the system.
      - 'EFI stub: Booting Linux Kernel...'
      - 'EFI stub: Using DTB from configuration table'
      - Linux version
      - 'efi: ESRT=0x'
      - 'esrt: Reserving ESRT space from 0x'
      - systemd
      - Executing FWTS for EBBR
      - 'Test: UEFI'
      - Loading BSA ACS Linux Driver
      - Executing BSA ACS Application
      - copying fdt
      - Running dt-validate tool
      - ACS run is completed
      - Please press <Enter> to continue ...
    warn-once-if-contains:
      - -dirty
      - 'EFI stub: ERROR:'
      - 'FIRMWARE BUG:'
      - OVERLAP DETECTED
    error-if-contains:
      - No EFI system partition
      - Failed to persist EFI variables
  - dir: acs_results
    min-entries: 8  # Allow missing result.md
    max-entries: 9
    tree:
      - file: result.md
        sct-parser-result-md:
          seq-file: sct_results/Sequence/EBBR.seq
        must-contain:
          - SCT Summary
          - Dropped:|0|
          - Failure:|0|
          - Warning:|0|
          - Dropped by group
          - Failure by group
          - Ignored by group
          - Warning by group
      - dir: app_output
        min-entries: 2
        max-entries: 2
        tree:
          - file: CapsuleApp_ESRT_table_info.log
            capsuleapp-esrt:
            must-contain:
              - ESRT TABLE
              - 'EFI_SYSTEM_RESOURCE_TABLE:'
              - EFI_SYSTEM_RESOURCE_ENTRY
              - FwClass
            error-if-contains:
              - FwResourceCount    - 0x0
              - FwResourceCountMax - 0x0
              - ESRT - Not Found
          - file: CapsuleApp_FMP_protocol_info.log
            must-contain:
              - FMP DATA
      - dir: fwts
        min-entries: 1
        max-entries: 1
        tree:
          - file: FWTSResults.log
            must-contain:
              - SystemReady IR ACS v2.
              - FWTS v2
              - 'Results generated by fwts: Version V2'
              - 'Running tests: uefivarinfo esrt uefibootpath dt_base'
              - 'esrt: Sanity check UEFI ESRT Table.'
              - Test Failure Summary
              - 'Critical failures: NONE'
              - 'High failures: NONE'
              - 'Medium failures: NONE'
              - 'Low failures: NONE'
              - 'Other failures: NONE'
              - 'Total:'
            warn-if-contains:
              - Aborted test
            error-if-contains:
              - FAILED
              - This is an invalid entry.
              - 'esrt: Cannot find any entries on directory
                /sys/firmware/efi/esrt/entries'
              - 'esrt: The FwResourceCount value should not be 0.'
              - 'esrt: The FwResourceCountMax value should not be 0.'
              - 'uefirtmisc: Failed to get high monotonic count with UEFI
                runtime service.'
              - 'uefirttime: Failed to set time with UEFI runtime service.'
      - dir: linux_acs
        min-entries: 1
        max-entries: 1
        tree:
          - dir: bsa_acs_app
            min-entries: 2
            max-entries: 2
            tree:
              - file: BSALinuxResults.log
                must-contain:
                  - SystemReady IR ACS v2.
                  - BSA v1.0.
                  - BSA Architecture Compliance Suite
                  - Version 1.0.
                  - Starting tests
                  - BSA tests complete
              - file: BsaResultsKernel.log
                must-contain:
                  - Number of PE detected
                  - Tests Failed =  0
      - dir: linux_dump
        min-entries: 10     # Allow missing lsusb.log
        max-entries: 11
        tree:
          - file: cpuinfo.log
            must-contain:
              - processor
              - BogoMIPS
              - Features
              - CPU implementer
              - 'CPU architecture: 8'
              - CPU variant
              - CPU part
              - CPU revision
          - file: dmidecode.log
            must-contain:
              - '# dmidecode 3.4'
          - file: efibootmgr.log
          - dir: firmware
            min-entries: 4
            max-entries: 4
            tree:
              - dir: devicetree
                min-entries: 1
                max-entries: 1
                tree:
                  - dir: base
                    tree:
                      - dir: chosen
                        min-entries: 7
                        tree:
                          - file: stdout-path
                      - dir: psci
                        min-entries: 3
                        tree:
                          - file: compatible
                            must-contain:
                              - arm,psci-
                          - file: method
                            warn-if-contains:
                              - hvc
                          - file: name
                            must-contain:
                              - psci
              - dir: dmi
              - dir: efi
                min-entries: 1
                tree:
                  - dir: efivars
                    tree:
                      - file: OsIndicationsSupported-*
                  - dir: esrt
                    tree:
                      - dir: entries
                        tree:
                          - dir: entry*
                            tree:
                              - file: capsule_flags
                              - file: fw_class
                              - file: fw_type
                              - file: fw_version
                              - file: last_attempt_status
                              - file: last_attempt_version
                              - file: lowest_supported_fw_version
                      - file: fw_resource_count
                        error-if-contains:
                          - '0'
                      - file: fw_resource_count_max
                        error-if-contains:
                          - '0'
                      - file: fw_resource_version
              - file: fdt
          - file: firmware.log
            must-contain:
              - '/sys/firmware:'
              - fdt
          - file: interrupts.log
            must-contain:
              - CPU0
              - Rescheduling interrupts
              - Function call interrupts
              - CPU stop interrupts
              - CPU stop (for crash dump) interrupts
              - Timer broadcast interrupts
              - IRQ work interrupts
              - CPU wake-up interrupts
          - file: iomem.log
            must-contain:
              - System RAM
          - file: lspci.log
            can-be-empty:
          - file: lsusb.log
            optional:
            can-be-empty:
          - file: meminfo.log
            must-contain:
              - MemTotal
              - MemFree
              - MemAvailable
          - file: uname.log
            must-contain:
              - 'Linux generic-arm64 6.0.0-yocto-standard #1 SMP PREEMPT Sun Oct
                2 21:09:07 UTC 2022 aarch64 GNU/Linux'
      - dir: linux_tools
        min-entries: 1
        max-entries: 2  # Allow dt-validate.log.old
        tree:
          - file: dt-validate.log*
            must-contain:
              - 'DeviceTree bindings of Linux kernel version: '
              - 'dtschema version: 2022.9'
      - dir: sct_results
        min-entries: 3
        max-entries: 3
        tree:
          - dir: EfiCompliantBBTest
            min-entries: 1
            max-entries: 1
            tree:
              - file: EfiCompliant.ini
                must-contain:
                  - Test Configuration Specific
                  - Platform Specific
          - dir: Overall
            min-entries: 2
            max-entries: 2
            tree:
              - file: Summary.ekl
                must-contain:
                  - '|HEAD|'
                  - '|TERM|'
              - file: Summary.log
                must-contain:
                  - 'Arm ACS Version: SystemReady IR ACS v2.'
                  - BBR ACS 1.0.
                  - 'Test Finished:'
          - dir: Sequence
            min-entries: 3
            max-entries: 3
            tree:
              - file: EBBR_manual.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
              - file: EBBR.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
              - file: BBSR.seq
                must-contain:
                  - '[Test Case]'
                  - Revision=
                  - Guid=
                  - Name=
                  - Order=
                  - Iterations=
      - dir: uefi
        min-entries: 2
        max-entries: 4  # Allow to generate BsaDevTree.dtb.log and temp folder
        tree:
          - file: BsaDevTree.dtb
            devicetree:
          - file: BsaDevTree.dtb.log  # This will be generated
            must-contain:
              - + DTC
              - + DT-VALIDATE
              - + END
          - file: BsaResults.log
            must-contain:
              - BSA Architecture Compliance Suite
              - Version 1.0.
              - Starting tests
              - 'PE_INFO: Number of PE detected'
              - Operating System
              - Total Tests run
              - BSA tests complete. Reset the system.
          - dir: temp   # This sometimes remains; ignore it
            min-entries: 0
            optional:
      - dir: uefi_dump
        min-entries: 13
        max-entries: 13
        tree:
          - file: bcfg.log
          - file: devices.log
            must-contain:
              - Device Name
          - file: devtree.log
            must-contain:
              - /HD(1,GPT,
              - /HD(2,GPT,
              - /HD(3,GPT,
          - file: dh.log
            must-contain:
              - Handle dump
              - DevicePath
              - EFISystemPartition
              - FirmwareManagement
              - SimpleTextOut
          - file: dmem.log
            must-contain:
              - Memory Address
              - Valid EFI Header at Address
              - 'System: Table Structure size'
              - Runtime Services
              - Boot Services
              - SAL System Table
              - ACPI Table
              - ACPI 2.0 Table
              - MPS Table
              - SMBIOS Table
          - file: dmpstore.log
            must-contain:
              - Variable
              - SecureBoot
          - file: drivers.log
            must-contain:
              - DRIVER NAME
          - file: ifconfig.log
          - file: map.log
            must-contain:
              - Mapping table
              - /HD(1,GPT,
              - /HD(2,GPT,
              - /HD(3,GPT,
          - file: memmap.log
            must-contain:
              - '# Pages'
              - 'Reserved  :'
              - 'LoaderCode:'
              - 'LoaderData:'
              - 'BS_Code   :'
              - 'BS_Data   :'
              - 'RT_Code   :'
              - 'RT_Data   :'
              - 'ACPI_Recl :'
              - 'ACPI_NVS  :'
              - 'MMIO      :'
              - 'MMIO_Port :'
              - 'PalCode   :'
              - 'Unaccepted:'
              - 'Available :'
              - 'Persistent:'
              - 'Total Memory:'
          - file: pci.log
          - file: smbiosview.log
            optional:
            must-contain:
              - 'SMBIOS Entry Point Structure:'
          - file: uefi_version.log
            must-contain:
              - UEFI Interactive Shell v2.2
              - EDK II
              - UEFI v2.
  - dir: docs
    optional:
    min-entries: 0
  - dir: fw
    min-entries: 3
    tree:
      - file: u-boot-sniff.log
        must-contain:
          # We check only that all non-hw-related commands are there for now.
          # RTC is a special case as we have an emulation in U-Boot.
          - help
          - version
          - printenv
          - printenv -e
          - bdinfo
          - rtc list
          - efidebug devices
          - efidebug drivers
          - efidebug dh
          - Device Path
          # Depending on U-Boot version, the ESP is marked either `System
          # Partition' or `system'; we can thus not search for it.
          - efidebug memmap
          - efidebug tables
          - efidebug query
          - efidebug boot dump
          - efidebug capsule esrt
          # We omit the bootefi hello and selftest as not everybody keeps them
          # in production.
        warn-once-if-contains:
          - -dirty
          - 'EFI stub: ERROR:'
          - 'FIRMWARE BUG:'
          - OVERLAP DETECTED
        error-if-contains:
          - No EFI system partition
          - Failed to persist EFI variables
      - file: uefi-sniff.log
        uefi-sniff:
        must-contain:
          - dmem
          - pci
          - drivers
          - devices
          - devtree
          - dmpstore
          - dh -d -v
          - DevicePath
          - EFISystemPartition
          - memmap
          - smbiosview
        warn-once-if-contains:
          - -dirty
          - 'EFI stub: ERROR:'
          - 'FIRMWARE BUG:'
          - OVERLAP DETECTED
        error-if-contains:
          - No EFI system partition
          - Failed to persist EFI variables
      - file: capsule-update.log
        must-have-esp:
        must-contain:
          - Welcome to GRUB!
          - UEFI Interactive Shell v2.2
          - CapsuleApp.efi -D
          - FmpCapsule
          - CapsuleApp.efi
          - 'CapsuleApp: failed to update capsule - Security Violation'
          - CapsuleApp.efi -D
          - FmpCapsule
          - CapsuleApp.efi
          - 'CapsuleApp: failed to update capsule - Security Violation'
          - CapsuleApp.efi -D
          - FmpCapsule
          - CapsuleApp.efi
          - Welcome to GRUB!
          - UEFI Interactive Shell v2.2
          - CapsuleApp.efi -E
          - ESRT TABLE
        warn-once-if-contains:
          - -dirty
          - 'EFI stub: ERROR:'
          - 'FIRMWARE BUG:'
          - OVERLAP DETECTED
        error-if-contains:
          - No EFI system partition
          - Failed to persist EFI variables
      - file: capsule-on-disk.log
        must-have-esp:
        must-contain:
          - Welcome to GRUB!
          - UEFI Interactive Shell v2.2
          - CapsuleApp.efi -D
          - FmpCapsule
          - -OD
          - Welcome to GRUB!
          - UEFI Interactive Shell v2.2
          - CapsuleApp.efi -E
          - ESRT TABLE
        warn-once-if-contains:
          - -dirty
          - 'EFI stub: ERROR:'
          - 'FIRMWARE BUG:'
          - OVERLAP DETECTED
        error-if-contains:
          - No EFI system partition
          - Failed to persist EFI variables
      - file: 'capsule*.bin'
        uefi-capsule:
  - dir: manual-results
    optional:
  - dir: os-logs
    min-entries: 2
    tree:
      - file: 'OS-image-download-links.txt'
        optional:
        must-contain:
          - For SystemReady IR
      - dir: 'linux-*'
        min-occurrences: 2
        tree:
          - file: '*console.log'
            warn-if-not-named: console.log
            must-contain:
              - dmesg
              - Linux version
              - lspci -vvv
              - lscpu
              - lsblk
              - dmidecode
              - uname -a
              - efibootmgr
              - tar
            warn-once-if-contains:
              - -dirty
              - 'EFI stub: ERROR:'
              - 'FIRMWARE BUG:'
              - OVERLAP DETECTED
            error-if-contains:
              - No EFI system partition
              - Failed to persist EFI variables
          - file: '*sys-firmware.tar.gz'
            warn-if-not-named: sys-firmware.tar.gz
  - file: report.txt
    must-contain:
      - General information
      - Test logs and results collected
    warn-if-contains:
      - '[ ]'

overlays:

  # (Ab)use the overlay mechanism to emit an error with IR v2.0.
  - when-any: [IR v2.0]
    tree:
      - file: '!!! This is not the right branch to use for checking IR v2.0
        results; use branch ir2.0 instead !!!'

  - when-any: [IR v2.0 with SIE, IR v2.1 with SIE]
    tree:
      - file: sie-console.log
        must-have-esp:
        must-contain:
          - Press any key to stop the SIE SCT running
          - Test preparing...
          - Done!
          - SIE SCT test suite execution is complete. Resetting the system
          - 'EFI stub: Booting Linux Kernel...'
          - 'EFI stub: UEFI Secure Boot is enabled.'
          - 'EFI stub: Using DTB from configuration table'
          - Linux version
          - 'efi: ESRT=0x'
          - 'esrt: Reserving ESRT space from 0x'
          - secureboot
          - systemd
          - Call SIE ACS in Linux
          - SecureBoot enabled
          - The system is in SecureBoot mode
          - 'Test: Authenticated variable'
          - SIE ACS run is completed
          - Please press <Enter> to continue ...
        warn-once-if-contains:
          - -dirty
          - 'EFI stub: ERROR:'
          - 'FIRMWARE BUG:'
          - OVERLAP DETECTED
        error-if-contains:
          - No EFI system partition
          - Failed to persist EFI variables
      - dir: acs_results
        min-entries: 9   # Allow missing result.md
        max-entries: 10  # Allow SIE folder
        tree:
          - dir: SIE
            min-entries: 3  # Allow missing result.md
            max-entries: 4
            tree:
              - file: result.md
                sct-parser-result-md:
                  seq-file: sct_results/Sequence/BBSR.seq
                must-contain:
                  - SCT Summary
                  - Dropped:|0|
                  - Failure:|0|
                  - Warning:|0|
                  - Dropped by group
                  - Failure by group
                  - Ignored by group
                  - Warning by group
              - dir: fwts
                min-entries: 1
                max-entries: 1
                tree:
                  - file: FWTSResults.log
                    must-contain:
                      - 'Results generated by fwts: Version V2'
                      - 'Running tests: uefirtauthvar tpm2.'
                      - Test Failure Summary
                      - 'Critical failures: NONE'
                      - 'High failures: NONE'
                      - 'Medium failures: NONE'
                      - 'Low failures: NONE'
                      - 'Other failures: NONE'
                      - 'Total:'
                    warn-if-contains:
                      - 'WARNING:'
                    error-if-contains:
                      - FAILED
                      - 'uefirtauthvar: Failed to create authenticated variable
                        with UEFI runtime service.'
                      - 'uefirtauthvar: Failed to set authenticated variable
                        with UEFI runtime service.'
                      - 'uefirtauthvar: Set authenticated variable expected
                        fail but success'
                      - 'uefirtauthvar: Set authenticated variable fail'
              - dir: sct_results
                min-entries: 3
                max-entries: 3
                tree:
                  - dir: EfiCompliantBBTest
                    min-entries: 1
                    max-entries: 1
                    tree:
                      - file: EfiCompliant.ini
                        must-contain:
                          - Test Configuration Specific
                          - Platform Specific
                  - dir: Overall
                    min-entries: 2
                    max-entries: 2
                    tree:
                      - file: Summary.ekl
                        must-contain:
                          - '|HEAD|'
                          - '|TERM|'
                      - file: Summary.log
                        must-contain:
                          - 'Arm ACS Version: SystemReady IR ACS v2.'
                          - BBR ACS 1.0.
                          - 'Test Finished:'
                  - dir: Sequence
                    min-entries: 3
                    max-entries: 3
                    tree:
                      - file: BBSR.seq
                        must-contain:
                          - '[Test Case]'
                          - Revision=
                          - Guid=
                          - Name=
                          - Order=
                          - Iterations=
                      - file: EBBR_manual.seq
                        must-contain:
                          - '[Test Case]'
                          - Revision=
                          - Guid=
                          - Name=
                          - Order=
                          - Iterations=
                      - file: EBBR.seq
                        must-contain:
                          - '[Test Case]'
                          - Revision=
                          - Guid=
                          - Name=
                          - Order=
                          - Iterations=
              - dir: tpm2
                min-entries: 0
                optional:

  - when-any: [IR v2.1]
    tree:
      - dir: acs_results
        max-entries: 10  # Allow missing result.md
        min-entries: 9
        tree:
          - dir: edk2-test-parser
            max-entries: 1
            min-entries: 1
            tree:
              - file: edk2-test-parser.log
                must-contain:
                  - SCT Summary
                  - 'Dropped:'
                  - 'Failure:'
                  - 'Ignored:'
                  - 'Pass:'
                  - 'Warning:'

          - dir: linux_dump
            max-entries: 12
            min-entries: 11
            tree:
              - file: sys_hierarchy.log
                must-contain:
                  - /sys
                  - block
              - file: uname.log
                must-contain:
                  - 'Linux generic-arm64 6.4.0-yocto-standard+ #1 SMP PREEMPT
                    Sun Jun 25 23:29:58 UTC 2023 aarch64 GNU/Linux'

          - dir: linux_tools
            max-entries: 6
            min-entries: 4
            tree:
              - file: dt-validate.log*
                must-contain:
                  - 'DeviceTree bindings of Linux kernel version: '
                  - 'dtschema version: 2023.7'
              - file: device_tree.dts
                must-contain:
                  - compatible
              - file: device_driver_info.log
                optional: null
              - ethernet: null
                file: ethtool-test.log
                must-contain:
                  - 'INFO: Detected following ethernet interfaces
                    via ip command :'
              - file: read_blk_devices.log
                must-contain:
                  - 'INFO: Detected following block devices
                    with lsblk command :'
          - dir: uefi_dump
            tree:
              - file: devtree.log
                must-contain:
                  - /HD(1,GPT,
                  - /HD(2,GPT,
                  # No third partition on IR 2.1
              - file: map.log
                must-contain:
                  - Mapping table
                  - /HD(1,GPT,
                  - /HD(2,GPT,
                  # No third partition on IR 2.1

  - when-any: [IR v2.1 with SIE]
    tree:
      - dir: acs_results
        min-entries: 10   # Allow missing result.md
        max-entries: 11  # Allow SIE folder

  # (Ab)use the overlay mechanism to emit an error with IR v1.x.
  - when-any: [IR v1.]
    tree:
      - file: '!!! This is not the right configuration to use for checking IR
        v1.x results; use check-sr-results-ir1.yaml instead !!!'

  # (Ab)use the overlay mechanism to emit an error with SIE.
  - when-any: [SIE v1]
    tree:
      - file: '!!! This is not the right configuration to use for checking SIE
        results !!!'
